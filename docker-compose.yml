services:
  #######################################
  # Clean services - remove build artifacts
  #######################################

  clean-linux-x86_64:
    build:
      context: .
      dockerfile: docker/Dockerfile
    volumes:
      - .:/workspace:rw
    working_dir: /workspace
    command: >
      bash -c "
        rm -rf /workspace/.lib-prebuilt/linux-x86_64/qt6-build/* \
               /workspace/.lib-prebuilt/linux-x86_64/qt6 \
               /workspace/.lib-prebuilt/linux-x86_64/.qt-stamp \
               /workspace/.lib-prebuilt/linux-x86_64/curl-build \
               /workspace/.lib-prebuilt/linux-x86_64/curl \
               /workspace/.lib-prebuilt/linux-x86_64/.curl-stamp \
               /workspace/.lib-prebuilt/linux-x86_64/glog-build \
               /workspace/.lib-prebuilt/linux-x86_64/glog \
               /workspace/.lib-prebuilt/linux-x86_64/.glog-stamp \
               /workspace/.build/linux-x86_64/CMakeCache.txt \
               /workspace/.build/linux-x86_64/CMakeFiles 2>/dev/null;
        echo 'Cleaned linux-x86_64 build'
      "

  clean-linux-arm64:
    build:
      context: .
      dockerfile: docker/Dockerfile
    volumes:
      - .:/workspace:rw
    working_dir: /workspace
    command: >
      bash -c "
        rm -rf /workspace/.lib-prebuilt/linux-arm64/qt6-build/* \
               /workspace/.lib-prebuilt/linux-arm64/qt6 \
               /workspace/.lib-prebuilt/linux-arm64/.qt-stamp \
               /workspace/.lib-prebuilt/linux-arm64/curl-build \
               /workspace/.lib-prebuilt/linux-arm64/curl \
               /workspace/.lib-prebuilt/linux-arm64/.curl-stamp \
               /workspace/.lib-prebuilt/linux-arm64/glog-build \
               /workspace/.lib-prebuilt/linux-arm64/glog \
               /workspace/.lib-prebuilt/linux-arm64/.glog-stamp \
               /workspace/.build/linux-arm64/CMakeCache.txt \
               /workspace/.build/linux-arm64/CMakeFiles 2>/dev/null;
        echo 'Cleaned linux-arm64 build'
      "

  clean-windows-x86_64:
    build:
      context: .
      dockerfile: docker/Dockerfile
    volumes:
      - .:/workspace:rw
    working_dir: /workspace
    command: >
      bash -c "
        rm -rf /workspace/.lib-prebuilt/windows-x86_64 \
               /workspace/.build/windows-x86_64 2>/dev/null;
        echo 'Cleaned windows-x86_64 build'
      "

  clean-windows-arm64:
    build:
      context: .
      dockerfile: docker/Dockerfile
    volumes:
      - .:/workspace:rw
    working_dir: /workspace
    command: >
      bash -c "
        rm -rf /workspace/.lib-prebuilt/windows-arm64 \
               /workspace/.build/windows-arm64 2>/dev/null;
        echo 'Cleaned windows-arm64 build'
      "

  #######################################
  # Linux x86_64 build services
  # Uses cross-compilation (works on any host architecture)
  #######################################

  deps-linux-x86_64:
    build:
      context: .
      dockerfile: docker/Dockerfile
    volumes:
      - .:/workspace:rw
    working_dir: /workspace
    command: >
      bash -c "
        cmake -B .build/linux-x86_64 -DTARGET_PLATFORM=linux-x86_64 &&
        cmake --build .build/linux-x86_64 --target deps -j$(nproc)
      "

  app-linux-x86_64:
    build:
      context: .
      dockerfile: docker/Dockerfile
    volumes:
      - .:/workspace:rw
    working_dir: /workspace
    command: >
      bash -c "
        cmake -B .build/linux-x86_64 -DTARGET_PLATFORM=linux-x86_64 &&
        cmake --build .build/linux-x86_64 --target rick_and_morty_viewer -j$(nproc)
      "

  distribute-linux-x86_64:
    build:
      context: .
      dockerfile: docker/Dockerfile
    volumes:
      - .:/workspace:rw
    working_dir: /workspace
    command: >
      bash -c "
        cmake --build .build/linux-x86_64 --target distribute
      "

  appimage-linux-x86_64:
    build:
      context: .
      dockerfile: docker/Dockerfile
    volumes:
      - .:/workspace:rw
    working_dir: /workspace
    privileged: true
    command: >
      bash -c "
        cmake --build .build/linux-x86_64 --target appimage
      "

  # Bundle glibc into x86_64 AppImage (requires platform emulation on ARM64 hosts)
  bundle-glibc-linux-x86_64:
    build:
      context: .
      dockerfile: docker/Dockerfile
    volumes:
      - .:/workspace:rw
    working_dir: /workspace
    command: >
      bash -c "
        bash /workspace/cmake/bundle-glibc.sh /workspace/.distribute/linux-x86_64/AppDir x86_64
      "

  #######################################
  # Linux ARM64 build services
  # Uses platform directive for native/QEMU builds
  #######################################

  deps-linux-arm64:
    build:
      context: .
      dockerfile: docker/Dockerfile
    volumes:
      - .:/workspace:rw
    working_dir: /workspace
    command: >
      bash -c "
        cmake -B .build/linux-arm64 -DTARGET_PLATFORM=linux-arm64 &&
        cmake --build .build/linux-arm64 --target deps -j$(nproc)
      "

  app-linux-arm64:
    build:
      context: .
      dockerfile: docker/Dockerfile
    volumes:
      - .:/workspace:rw
    working_dir: /workspace
    command: >
      bash -c "
        cmake -B .build/linux-arm64 -DTARGET_PLATFORM=linux-arm64 &&
        cmake --build .build/linux-arm64 --target rick_and_morty_viewer -j$(nproc)
      "

  distribute-linux-arm64:
    build:
      context: .
      dockerfile: docker/Dockerfile
    volumes:
      - .:/workspace:rw
    working_dir: /workspace
    command: >
      bash -c "
        cmake --build .build/linux-arm64 --target distribute
      "

  appimage-linux-arm64:
    build:
      context: .
      dockerfile: docker/Dockerfile
    volumes:
      - .:/workspace:rw
    working_dir: /workspace
    privileged: true
    command: >
      bash -c "
        cmake --build .build/linux-arm64 --target appimage
      "

  #######################################
  # Windows x86_64 cross-compilation (MinGW)
  # Requires host Qt built first (linux-x86_64 or linux-arm64)
  #######################################

  deps-windows-x86_64:
    build:
      context: .
      dockerfile: docker/Dockerfile
    volumes:
      - .:/workspace:rw
    working_dir: /workspace
    command: >
      bash -c "
        cmake -B .build/windows-x86_64 -DTARGET_PLATFORM=windows-x86_64 &&
        cmake --build .build/windows-x86_64 --target deps -j$(nproc)
      "

  app-windows-x86_64:
    build:
      context: .
      dockerfile: docker/Dockerfile
    volumes:
      - .:/workspace:rw
    working_dir: /workspace
    command: >
      bash -c "
        cmake -B .build/windows-x86_64 -DTARGET_PLATFORM=windows-x86_64 &&
        cmake --build .build/windows-x86_64 --target rick_and_morty_viewer -j$(nproc)
      "

  distribute-windows-x86_64:
    build:
      context: .
      dockerfile: docker/Dockerfile
    volumes:
      - .:/workspace:rw
    working_dir: /workspace
    command: >
      bash -c "
        cmake --build .build/windows-x86_64 --target distribute
      "

  #######################################
  # Windows ARM64 cross-compilation (llvm-mingw)
  # Requires host Qt built first (linux-x86_64 or linux-arm64)
  #######################################

  deps-windows-arm64:
    build:
      context: .
      dockerfile: docker/Dockerfile
    volumes:
      - .:/workspace:rw
    working_dir: /workspace
    command: >
      bash -c "
        cmake -B .build/windows-arm64 -DTARGET_PLATFORM=windows-arm64 &&
        cmake --build .build/windows-arm64 --target deps -j$(nproc)
      "

  app-windows-arm64:
    build:
      context: .
      dockerfile: docker/Dockerfile
    volumes:
      - .:/workspace:rw
    working_dir: /workspace
    command: >
      bash -c "
        cmake -B .build/windows-arm64 -DTARGET_PLATFORM=windows-arm64 &&
        cmake --build .build/windows-arm64 --target rick_and_morty_viewer -j$(nproc)
      "

  distribute-windows-arm64:
    build:
      context: .
      dockerfile: docker/Dockerfile
    volumes:
      - .:/workspace:rw
    working_dir: /workspace
    command: >
      bash -c "
        cmake --build .build/windows-arm64 --target distribute
      "

  #######################################
  # AppImage test services (execution only)
  #######################################

  test-linux-arm64:
    build:
      context: .
      dockerfile: docker/Dockerfile
    platform: linux/arm64
    volumes:
      - ./.distribute:/dist:ro
    command: >
      bash -c "
        set -e;
        LOG=/tmp/app.log;
        QT_QPA_PLATFORM=offscreen /dist/RickAndMortyViewer-aarch64.AppImage --appimage-extract-and-run >\"$$LOG\" 2>&1 &
        APP_PID=$$!;
        trap 'kill $$APP_PID 2>/dev/null || true' EXIT;
        sleep 8;
        if grep -q 'HTTP response code: 200' \"$$LOG\"; then
          echo 'HTTPS OK';
        else
          echo 'HTTPS check failed';
          tail -n 200 \"$$LOG\";
          exit 1;
        fi
      "

  test-linux-x86_64:
    build:
      context: .
      dockerfile: docker/Dockerfile
    platform: linux/amd64
    volumes:
      - ./.distribute:/dist:ro
    command: >
      bash -c "
        set -e;
        LOG=/tmp/app.log;
        QT_QPA_PLATFORM=offscreen /dist/RickAndMortyViewer-x86_64.AppImage --appimage-extract-and-run >\"$$LOG\" 2>&1 &
        APP_PID=$$!;
        trap 'kill $$APP_PID 2>/dev/null || true' EXIT;
        sleep 8;
        if grep -q 'HTTP response code: 200' \"$$LOG\"; then
          echo 'HTTPS OK';
        else
          echo 'HTTPS check failed';
          tail -n 200 \"$$LOG\";
          exit 1;
        fi
      "
